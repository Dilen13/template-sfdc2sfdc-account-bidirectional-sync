<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:batch="http://www.mulesoft.org/schema/mule/batch" xmlns:objectstore="http://www.mulesoft.org/schema/mule/objectstore"
	xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:sfdc="http://www.mulesoft.org/schema/mule/sfdc"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/sfdc http://www.mulesoft.org/schema/mule/sfdc/current/mule-sfdc.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/objectstore http://www.mulesoft.org/schema/mule/objectstore/current/mule-objectstore.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd"
	version="EE-3.5.0">
    
    <batch:job name="syncBatch">
        <batch:threading-profile poolExhaustedAction="WAIT"/>
        <batch:process-records>
            <batch:step name="forEachAccountInSourceGetAccounttInTargetStep">
                <batch:set-record-variable variableName="accountInSourceInstance" value="#[payload]" doc:name="store account in source instance"/>
                <enricher source="#[payload]" target="#[recordVars['accountInTargetInstance']]" doc:name="store account">
	                <sfdc:query-single config-ref="Salesforce" username="#[flowVars['targetSfdcUsername']]" password="#[flowVars['targetSfdcPassword']]" securityToken="#[flowVars['targetSfdcSecurityToken']]" query="SELECT Id, Name, LastModifiedDate FROM Account WHERE (Name = '#[payload['Name']]')" doc:name="query account in target instance"/>
                </enricher>
            </batch:step>
            <batch:step name="forEachAccountThatShouldBeUpsertedInTaget" filter-expression="#[recordVars['accountInTargetInstance'] is NullPayload ? false : (recordVars['accountInTargetInstance'].get('LastModifiedDate') &gt;= recordVars['accountInSourceInstance'].get('LastModifiedDate')) || (flowVars['integrationUser'].get('Id') == recordVars['accountInSourceInstance'].get('LastModifiedById'))]">
				<expression-component doc:name="prepare account for upsert"><![CDATA[if(recordVars['accountInTargetInstance'] is org.mule.transport.NullPayload) {
	recordVars['accountInSourceInstance'].remove('Id');
	recordVars['accountInSourceInstance'].remove('LastModifiedById');
	recordVars['accountInSourceInstance'].remove('LastModifiedDate');
} else {
	recordVars['accountInSourceInstance'].put('Id',recordVars['accountInTargetInstance'].get('Id'));
	recordVars['accountInSourceInstance'].remove('LastModifiedById');
	recordVars['accountInSourceInstance'].remove('LastModifiedDate');
}
				]]></expression-component>
                <set-payload value="#[recordVars['accountInSourceInstance']]" doc:name="Set Payload"/>
                <batch:commit size="200" doc:name="Batch Commit">
			        <sfdc:upsert config-ref="Salesforce"  username="#[flowVars['targetSfdcUsername']]" password="#[flowVars['targetSfdcPassword']]" securityToken="#[flowVars['targetSfdcSecurityToken']]" externalIdFieldName="Id" type="Account" doc:name="upsert account in target instance">
			            <sfdc:objects ref="#[payload]"/>
			        </sfdc:upsert>
			        <logger message="Upsert Salesforce response: #[payload]" level="INFO" doc:name="log response"/>
                </batch:commit>
            </batch:step>
        </batch:process-records>
    </batch:job>
    
</mule>
